<html>
<head>
    <meta charset="utf-8"/>
    <title>Shapescapes</title>
    <style type="text/css">
        html {font-size: 13px;}
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background: #f0f0f0;
        }
        h1 {
            margin: 20px;
            font-size: 20px;
            line-height: 20px;
            font-weight: 300;
            color: #ccc;
        }
        h1 a {
            text-decoration: none;
            color: #808080;
        }
        h1 a:hover {
            color: #333;
        }
        #example {
            margin: 20px;
            position: relative;
            width: 400px;
            height: 600px;
            box-shadow: 0 1px 20px rgba(0, 0, 0, 0.2);
        }
        #example canvas {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        #example {}

        #saved {
            position: fixed;
            border-left: 1px solid #ccc;
            top: 0;
            right: 0;
            bottom: 0;
            left: 440px;
            padding-left: 10px;
            overflow: auto;
        }

        #saved > img {
            margin: 10px;
            box-shadow: 0 1px 10px rgba(0, 0, 0, 0.2);
            width: 200px;
        }

        #instructions {
            margin: 20px;
            color: #999;
        }

        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 0.5em 20px;
        }

        #controls button,
        #controls select,
        #controls input {
            display: inline-block;
            padding: 0 1em;
            font-size: 1.0rem;
            line-height: 3em;
            height: 3em;
            color: #000;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 0.2em;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <h1><a href="index.html">Shapescapes</a> | <a href="waterline.html">Waterlines</a></h1>
    <div id="example"></div>
    <div id="saved"><div id="instructions">Press space to redraw.<br/>Click image to add to tray.<br/>Drag from tray to desktop to save.</div></div>
    <div id="controls">
        <select onchange="setPalette(this.value)" id="paletteSelector"></select>
        <button onclick="createBatch()" id="newBatchTrigger">New Batch</button>
        <input type="text" id="customColors" placeholder="paste colors" />
    </div>
    <script src="js/colorbrewer.js"></script>
    <script src="js/noiseutils.js"></script>
    <script src="js/shapescape.js"></script>
    <script src="3p/DAT.GUI.min.js"></script>
    <script type="text/javascript">


        // Obj/array helpers
        function extend(dest, src) {
            for (k in src) {
                if (src.hasOwnProperty(k)) {
                    dest[k] = src[k];
                }
            }
            return dest;
        }

        function objToArray(obj) {
            var arr = [];
            for (key in obj) {
                if (obj.hasOwnProperty(key)) {
                    arr.push(obj[key]);
                }
            }
            return arr;
        }

        function arrayToObj(arr) {
            var obj = {};
            arr.forEach(function(val, i){
                obj[i] = val;
            });
            return obj;
        }





        // GUI controlled opts


        var visualOpts = {
            container: document.querySelector('#example'),
            clear: true,
            skew: 1,
            noiseInput: noiseUtils.createNoiseCanvas(0.04, 200)
        };


        var exampleNode = document.getElementById('example');


        function loadOpts(opts) {
            visualOpts = extend(visualOpts, opts);
            shapescape(visualOpts);
        }


        // Handlers for redraw, batching, and manual saving

        document.addEventListener('keypress', function(e) {
            var kode = e.which || e.keyCode;
            if (kode === 32) {
                requestAnimationFrame(loadOpts);
            }
        });

        function saveCanvas(canvas, container) {
            var pixels = canvas.toDataURL('image/png');
            var image = document.createElement('img');
            image.src = pixels;
            container.appendChild(image);
        }

        document.addEventListener('click', function(e) {
            if (e.target.nodeName === 'CANVAS') {
                saveCanvas(e.target, document.querySelector('#saved'));
            }
        });

        function createBatch(opts, N) {
            N = N || 9;
            var canvas = document.querySelector('#example canvas');
            var container = document.querySelector('#saved');
            container.innerHTML = '';
            for (var i=0; i < N ; i++) {
                requestAnimationFrame(function(){
                    loadOpts(opts);
                    saveCanvas(canvas, container);
                });
            }

            // focus image for rerender binding
            document.querySelector('#newBatchTrigger').blur();
            document.querySelector('#example').focus();
        }


        // Option sets:

        var palettes = {
            Standard: null,
            black_white: ["#111111", "#444444", "#999999", "#ffffff"],
            black_white_red: ["#111111", "#444444", "#999999", "#ffffff", '#880000', '#dd0000'],
        }

        // create a batch from a colorbrewer name
        function setPalette(pname) {
            if (!palettes[pname]) {
                delete visualOpts.palette;
            } else {
                visualOpts.palette = palettes[pname];
            }
            return loadOpts({});
        }

        // populate the selector for colorbrewer palettes
        if (colorbrewer) {
            var cbnames = Object.keys(colorbrewer);
            cbnames.forEach(function (pname) {
                palettes[pname] = colorbrewer[pname][6];
            });
        }

        var selectEl = document.querySelector('#paletteSelector');
        var pnames = Object.keys(palettes);
        pnames.forEach(function (pname) {
            var option = document.createElement('option');
            option.value = pname;
            option.innerHTML = pname;
            selectEl.appendChild(option);
        });

        function useCustomPalette(palette) {
            if(palette && palette.length) {
                visualOpts.palette = palette;
                selectEl.value = 'custom';
                shapescape(visualOpts);
            }
        }

        var custom = document.querySelector('#customColors');
        custom.addEventListener('keypress', function (e) {
            var hexPattern = /#?[0-9a-f]{3,6}/;
            var palette = e.target.value.split(',');
            palette = palette.map((s) => {
                s = s.trim();
                if (hexPattern.test(s) && !s.startsWith('#')) {
                    s = '#' + s;
                }
                return s;
            })
            useCustomPalette(palette);
        });

        // draw one to start
        loadOpts();

        // focus image for rerender binding
        document.querySelector('#example').focus();


    </script>
</body>
</html>