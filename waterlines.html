<html>
<head>
    <meta charset="utf-8"/>
    <title>Waterlines</title>
    <link rel="stylesheet" href="css/demo.css" />
    <style type="text/css">
        #example {
            //width: 800px;
            //height: 600px;

        }

        #saved {
            border-left: none;
            left: auto;
            width: 420px;
        }

        #saved img {
            width: 400px;
        }
    </style>
</head>
<body>
    <h1><a href="waterlines.html">Waterlines</a> | <a href="index.html">Shapescapes</a></h1>
    <div id="example"></div>
    <div id="saved"><div id="instructions">Press space to redraw.<br/>Click image to add to tray.<br/>Drag out from tray to save.</div></div>
    <div id="controls">
        <select onchange="setPalette(this.value)" id="paletteSelector"></select>
        <button onclick="createBatch()" id="newBatchTrigger">New Batch</button>
        <input type="text" id="customColors" placeholder="paste colors" />
    </div>
    <script src="js/colorbrewer.js"></script>
    <script src="js/noiseutils.js"></script>
    <script src="js/waterline.js"></script>
    <script src="3p/DAT.GUI.min.js"></script>
    <script type="text/javascript">


        // Obj/array helpers
        function extend(dest, src) {
            for (k in src) {
                if (src.hasOwnProperty(k)) {
                    dest[k] = src[k];
                }
            }
            return dest;
        }

        function objToArray(obj) {
            var arr = [];
            for (key in obj) {
                if (obj.hasOwnProperty(key)) {
                    arr.push(obj[key]);
                }
            }
            return arr;
        }

        function arrayToObj(arr) {
            var obj = {};
            arr.forEach(function(val, i){
                obj[i] = val;
            });
            return obj;
        }





        // GUI controlled opts
        var visualOpts = {
            container: document.querySelector('#example'),
            clear: true,
            dust: true,
            skew: 1,
            noiseInput: noiseUtils.createNoiseCanvas(0.04, 200)
        };


        var exampleNode = document.getElementById('example');


        function loadOpts(opts) {
            visualOpts = extend(visualOpts, opts);
            waterline(visualOpts);
        }


        // Handlers for redraw, batching, and manual saving

        document.addEventListener('keypress', function(e) {
            var kode = e.which || e.keyCode;
            if (kode === 32) {
                requestAnimationFrame(loadOpts);
            }
        });

        function saveCanvas(canvas, container) {
            var pixels = canvas.toDataURL('image/png');
            var image = document.createElement('img');
            image.src = pixels;
            container.appendChild(image);
        }

        document.addEventListener('click', function(e) {
            if (e.target.nodeName === 'CANVAS') {
                saveCanvas(e.target, document.querySelector('#saved'));
            }
        });

        function createBatch(opts, N) {
            N = N || 9;
            var canvas = document.querySelector('#example canvas');
            var container = document.querySelector('#saved');
            container.innerHTML = '';
            for (var i=0; i < N ; i++) {
                requestAnimationFrame(function(){
                    loadOpts(opts);
                    saveCanvas(canvas, container);
                });
            }
        }


        // Option sets:

        var palettes = {
            standard: null,
            black_white: ["#111111", "#444444", "#999999", "#ffffff"],
            black_white_red: ["#111111", "#444444", "#999999", "#ffffff", '#880000', '#dd0000'],
            dd: ["#ff0099", "#774aa4", "#3399cc", "#ffcc00"]
        }

        // create a batch from a colorbrewer name
        function setPalette(pname) {
            if (!palettes[pname]) {
                delete visualOpts.palette;
            } else {
                visualOpts.palette = palettes[pname];
            }
            return loadOpts({});
        }

        // populate the selector for colorbrewer palettes
        if (colorbrewer) {
            var cbnames = Object.keys(colorbrewer);
            cbnames.forEach(function (pname) {
                palettes[pname] = colorbrewer[pname][6];
            });
        }

        var selectEl = document.querySelector('#paletteSelector');
        var pnames = Object.keys(palettes);
        pnames.forEach(function (pname) {
            var option = document.createElement('option');
            option.value = pname;
            option.innerHTML = pname;
            selectEl.appendChild(option);
        });

        function useCustomPalette(palette) {
            if(palette && palette.length) {
                visualOpts.palette = palette;
                selectEl.value = 'custom';
                waterline(visualOpts);
            }
        }

        var custom = document.querySelector('#customColors');
        custom.addEventListener('keypress', function (e) {
            var hexPattern = /#?[0-9a-f]{3,6}/;
            var palette = e.target.value.split(',');
            palette = palette.map((s) => {
                s = s.trim();
                if (hexPattern.test(s) && !s.startsWith('#')) {
                    s = '#' + s;
                }
                return s;
            })
            useCustomPalette(palette);
        });

        // set up the elements
        var width = 2400;
        var height = 2400;
        visualOpts.container.style.width = width;
        visualOpts.container.style.height = height;

        visualOpts.container.style.transformOrigin = 'top left';
        visualOpts.container.style.transform = 'scale(0.25)';

        // draw one to start
        loadOpts();


    </script>
</body>
</html>